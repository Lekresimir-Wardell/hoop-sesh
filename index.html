<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <title>Rezervacija termina</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    :root{
      --brand:#1D428A;
      --accent:#FFC72C;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f5f7fb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,Arial,Helvetica,sans-serif;
      background:var(--bg);
      color:#111;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Centered login */
    #loginWrapper{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    #loginBox{
      width:420px;
      max-width:95%;
      background:var(--card);
      border-radius:12px;
      padding:28px;
      box-shadow:0 10px 30px rgba(20,30,60,0.08);
      text-align:center;
    }
    #loginBox h1{margin:0 0 8px;font-size:20px;color:var(--brand)}
    #loginBox p{margin:0 0 20px;color:var(--muted)}

    #googleLoginBtn{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:12px 16px;
      background:var(--brand);
      color:var(--accent);
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      font-size:15px;
    }
    #googleLoginBtn img{width:18px;height:18px}

    /* App layout */
    #app{
      display:none;
      max-width:1200px;
      margin:20px auto;
      padding:20px;
      gap:20px;
    }
    header.appHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:12px;
    }
    .brand{
      display:flex;align-items:center;gap:12px;
    }
    .brand h2{margin:0;color:var(--brand)}
    .userBar{display:flex;align-items:center;gap:10px}
    .userEmail{color:var(--muted);font-size:14px}
    .logoutBtn{
      background:var(--accent);
      color:var(--brand);
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
    }

    /* Tabs */
    .tabs{
      display:flex;
      gap:6px;
      margin-left:12px;
      align-items:center;
    }
    .tabs button{cursor:pointer;border:none;border-radius:6px;font-weight:600;}

    /* Main content */
    .main{
      display:flex;
      gap:20px;
      align-items:flex-start;
    }
    .calendarCard{
      background:var(--card);
      border-radius:12px;
      padding:16px;
      flex: 1 1 65%;
      box-shadow:0 6px 18px rgba(20,30,60,0.06);
    }
    .controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:10px;
    }
    .monthNav{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .navBtn{
      padding:6px 10px;border-radius:8px;border:none;cursor:pointer;background:#efefef;
    }
    .monthTitle{font-weight:700;color:#0b1220}

    .weekdays{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      margin-top:8px;
    }
    .weekday{
      text-align:center;padding:6px 4px;font-weight:700;color:var(--muted);font-size:13px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:6px;
      margin-top:8px;
    }
    .day{
      min-height:84px;border-radius:8px;border:1px solid #e6e9ef;
      background:white;display:flex;flex-direction:column;
      padding:6px;justify-content:flex-start;gap:6px;position:relative;
      cursor:pointer;
    }
    .day.empty{background:transparent;border:none;cursor:default}
    .day .num{font-weight:700}
    .day .items{font-size:12px;color:#222;display:flex;flex-direction:column;gap:4px;overflow:hidden}
    .badge{display:inline-block;padding:4px 6px;border-radius:6px;font-size:12px}

    .available{background:linear-gradient(90deg,#e9eefb,#f7f9ff)}
    .mine{background:#e6fbff;border:2px solid #6BCBFF}
    .reserved-other{background:linear-gradient(90deg,#fff4e0,#fff8f0)}
    .past{opacity:0.5;pointer-events:none}

    .joinBtnLocal{
      margin-top:auto;background:transparent;border:1px solid #ccc;padding:6px;border-radius:6px;font-size:12px;cursor:pointer;
    }

    /* right panel - form */
    .formCard{
      background:var(--card);
      border-radius:12px;
      padding:16px;
      width:320px;
      box-shadow:0 6px 18px rgba(20,30,60,0.06);
      flex:0 0 320px;
    }
    .formCard h3{margin-top:0}
    .formRow{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
    input[type="text"],input[type="time"],select,textarea{
      padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px;width:100%;
    }
    .primaryBtn{background:var(--brand);color:var(--accent);border:none;padding:10px;border-radius:8px;cursor:pointer;font-weight:700}
    .secondary{background:#f0f0f0;border:none;padding:8px;border-radius:8px;cursor:pointer}

    .small{font-size:13px;color:var(--muted)}

    /* tooltip pre wrapping */
    .tooltip{
      white-space:pre-line;
      font-size:13px;
      color:#fff;
      background:#222;
      padding:6px 8px;border-radius:6px;
    }

    @media (max-width:900px){
      .main{flex-direction:column}
      .formCard{width:100%}
      #app{padding:12px}
    }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="loginWrapper">
    <div id="loginBox" role="dialog" aria-labelledby="loginTitle">
      <h1 id="loginTitle">Prijava</h1>
      <p>Prijavite se putem Google računa da biste rezervirali teren.</p>
      <button id="googleLoginBtn">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" />
        Prijavi se s Googleom
      </button>
    </div>
  </div>

  <!-- APP -->
  <div id="app">
    <header class="appHeader">
      <div class="brand">
        <h2>Rezervacije</h2>
        <div class="small">Upravljanje terminima</div>
        <div class="tabs">
          <button id="calendarTab" class="primaryBtn" style="font-size:14px;padding:6px 12px">Kalendar</button>
          <button id="leaderboardTab" class="secondary" style="font-size:14px;padding:6px 12px">Leaderboard</button>
        </div>
      </div>

      <div class="userBar">
        <div class="userEmail" id="userEmail">—</div>
        <button id="logoutBtn" class="logoutBtn">Odjava</button>
      </div>
    </header>

    <main class="main">
      <section class="calendarCard" aria-label="Kalendar">
        <div class="controls">
          <div class="monthNav">
            <button id="prevMonth" class="navBtn">&lt; Prethodni</button>
            <div class="monthTitle" id="monthTitle">Rujan 2025</div>
            <button id="nextMonth" class="navBtn">Sljedeći &gt;</button>
          </div>
          <div class="small">Kliknite dan za rezervaciju ili pregled</div>
        </div>

        <div class="weekdays" id="weekdays"></div>
        <div class="grid" id="daysGrid" role="grid"></div>
      </section>

      <aside class="formCard" aria-label="Forma za rezervaciju">
        <h3>Rezerviraj termin</h3>
        <div class="small">Odabrani datum: <span id="selectedDateText">—</span></div>

        <form id="reservationForm">
          <div class="formRow">
            <label class="small">Ime (možete promijeniti)</label>
            <input type="text" id="nameInput" required />
          </div>

          <div class="formRow">
            <label class="small">Vrijeme</label>
            <input type="time" id="timeInput" required />
          </div>

          <div class="formRow">
            <label class="small">Teren</label>
            <select id="terenSelect" required>
              <option value="">Odaberite teren</option>
              <option> Jadran </option>
              <option> Contadina </option>
              <option> Secrete </option>
              <option> Maj </option>
            </select>
          </div>

          <div style="display:flex;gap:8px">
            <button type="submit" class="primaryBtn">Rezerviraj</button>
            <button type="button" id="cancelBtn" class="secondary">Odustani</button>
          </div>

          <div style="margin-top:12px" id="formMsg" class="small"></div>
        </form>
      </aside>

      <!-- LEADERBOARD SECTION -->
      <section class="calendarCard" id="leaderboardSection" style="display:none;">
        <h3>Leaderboard</h3>
        <table id="leaderboardTable" style="width:100%;border-collapse:collapse">
          <thead>
            <tr>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #ccc">#</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #ccc">Ime</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #ccc">Wins</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #ccc">Losses</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #ccc">Points For</th>
              <th style="text-align:left;padding:6px;border-bottom:1px solid #ccc">Points Against</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>
    </main>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    GoogleAuthProvider,
    signInWithPopup,
    signOut
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    updateDoc,
    doc,
    Timestamp
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAnFYrebR69a2rmYeT-TWrX1RB_Tzsh3Tk",
    authDomain: "hoops-165ec.firebaseapp.com",
    projectId: "hoops-165ec",
    storageBucket: "hoops-165ec.firebasestorage.app",
    messagingSenderId: "563400604791",
    appId: "1:563400604791:web:50183bcf65de09bd019a72",
    measurementId: "G-C3YPHXZCXN"
  };

  const EMAILJS_USER_ID = "bHkaG3QCQ98fZq5Mu";
  const EMAILJS_SERVICE = "service_8fwmwyi";
  const EMAILJS_TEMPLATE_RESERVATION = "template_p01lv7f";
  const EMAILJS_TEMPLATE_JOINADMIN = "template_p01lv7f";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  (function(){ emailjs.init(EMAILJS_USER_ID); })();

  const loginWrapper = document.getElementById("loginWrapper");
  const loginBox = document.getElementById("loginBox");
  const googleLoginBtn = document.getElementById("googleLoginBtn");

  const appRoot = document.getElementById("app");
  const userEmailEl = document.getElementById("userEmail");
  const logoutBtn = document.getElementById("logoutBtn");

  const weekdaysContainer = document.getElementById("weekdays");
  const daysGrid = document.getElementById("daysGrid");
  const monthTitle = document.getElementById("monthTitle");
  const prevMonthBtn = document.getElementById("prevMonth");
  const nextMonthBtn = document.getElementById("nextMonth");

  const reservationForm = document.getElementById("reservationForm");
  const nameInput = document.getElementById("nameInput");
  const timeInput = document.getElementById("timeInput");
  const terenSelect = document.getElementById("terenSelect");
  const selectedDateText = document.getElementById("selectedDateText");
  const cancelBtn = document.getElementById("cancelBtn");
  const formMsg = document.getElementById("formMsg");

  const calendarTabBtn = document.getElementById("calendarTab");
  const leaderboardTabBtn = document.getElementById("leaderboardTab");
  const leaderboardSection = document.getElementById("leaderboardSection");
  const calendarCard = document.querySelector(".calendarCard");
  const formCard = document.querySelector(".formCard");

  let currentUser = null;
  let visibleYear = (new Date()).getFullYear();
  let visibleMonth = (new Date()).getMonth();
  let selectedDay = null;
  let reservationsCache = [];

  const WEEKDAYS = ["Pon","Uto","Sri","Čet","Pet","Sub","Ned"];

  googleLoginBtn.addEventListener("click", async () => {
    try{
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch(err){
      console.error("Login error", err);
      alert("Prijava nije uspjela: " + (err.message || err));
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  async function ensureUserInFirestore(user) {
    if (!user) return;
    const usersCol = collection(db, "users");
    const snapshot = await getDocs(usersCol);
    const exists = snapshot.docs.some(d => d.id === user.uid);
    if (!exists) {
      let chosenName = prompt("Odaberite ime koje će se prikazivati u leaderboardu:", user.displayName || "");
      if (!chosenName) chosenName = user.displayName || "Unnamed";
      await addDoc(usersCol, {
        uid: user.uid,
        email: user.email,
        name: chosenName,
        wins: 0,
        losses: 0,
        pointsFor: 0,
        pointsAgainst: 0,
        createdAt: Timestamp.now()
      });
    }
  }

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      loginWrapper.style.display = "none";
      appRoot.style.display = "block";
      userEmailEl.textContent = user.email;
      await ensureUserInFirestore(user);
      nameInput.value = user.displayName || "";
      await loadReservations();
      renderCalendar();
    } else {
      currentUser = null;
      loginWrapper.style.display = "flex";
      appRoot.style.display = "none";
    }
  });

  function monthYearTitle(year, month) {
    return new Date(year, month, 1).toLocaleString('hr-HR', { month: 'long', year: 'numeric' });
  }

  function startOfMonthWeekday(year, month) {
    const jsDay = new Date(year, month, 1).getDay();
    return (jsDay === 0) ? 6 : jsDay - 1;
  }

  function formatLocalDate(y,m,d){
    return `${String(d).padStart(2,'0')}.${String(m+1).padStart(2,'0')}.${y}`;
  }

  async function loadReservations(){
    reservationsCache = [];
    try {
      const snapshot = await getDocs(collection(db,"reservations"));
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        reservationsCache.push({ id: docSnap.id, ...data });
      });
    } catch(err){
      console.error("Error loading reservations", err);
      reservationsCache = [];
    }
  }

  function renderCalendar(){
    monthTitle.textContent = monthYearTitle(visibleYear,visibleMonth);
    weekdaysContainer.innerHTML = WEEKDAYS.map(d=>`<div class="weekday">${d}</div>`).join('');
    daysGrid.innerHTML = "";
    const firstWeekday = startOfMonthWeekday(visibleYear,visibleMonth);
    const daysInMonth = new Date(visibleYear, visibleMonth+1, 0).getDate();

    for(let i=0;i<firstWeekday;i++){
      const div = document.createElement("div");
      div.className="day empty"; daysGrid.appendChild(div);
    }

    for(let d=1; d<=daysInMonth; d++){
      const div = document.createElement("div"); div.className="day"; div.dataset.day=d;
      const numDiv = document.createElement("div"); numDiv.className="num"; numDiv.textContent=d;
      div.appendChild(numDiv);

      const itemsDiv = document.createElement("div"); itemsDiv.className="items";

      const dateStr = formatLocalDate(visibleYear,visibleMonth,d);
      const dayReservations = reservationsCache.filter(r=>r.date===dateStr);

      dayReservations.forEach(r=>{
        const span = document.createElement("div");
        span.textContent = `${r.name} - ${r.time} (${r.teren})`;
        if(r.userId===currentUser.uid) span.className="badge mine";
        else span.className="badge reserved-other";
        itemsDiv.appendChild(span);
      });

      div.appendChild(itemsDiv);

      if(new Date(visibleYear,visibleMonth,d)<new Date()) div.classList.add("past");

      div.addEventListener("click",()=>selectDay(d));
      daysGrid.appendChild(div);
    }
  }

  function selectDay(day){
    selectedDay = day;
    selectedDateText.textContent = formatLocalDate(visibleYear,visibleMonth,day);
  }

  prevMonthBtn.addEventListener("click",()=>{ visibleMonth--; if(visibleMonth<0){visibleMonth=11;visibleYear--;} renderCalendar(); });
  nextMonthBtn.addEventListener("click",()=>{ visibleMonth++; if(visibleMonth>11){visibleMonth=0;visibleYear++;} renderCalendar(); });

  reservationForm.addEventListener("submit",async (e)=>{
    e.preventDefault();
    if(!selectedDay){ formMsg.textContent="Odaberite datum."; return;}
    const data = {
      userId: currentUser.uid,
      name: nameInput.value,
      date: formatLocalDate(visibleYear,visibleMonth,selectedDay),
      time: timeInput.value,
      teren: terenSelect.value,
      createdAt: Timestamp.now()
    };
    try{
      await addDoc(collection(db,"reservations"),data);
      await loadReservations();
      renderCalendar();
      formMsg.textContent="Rezervacija je spremljena!";
      reservationForm.reset();
    } catch(err){
      console.error(err);
      formMsg.textContent="Greška pri spremanju rezervacije.";
    }
  });

  cancelBtn.addEventListener("click",()=>{reservationForm.reset(); selectedDateText.textContent="—";});

  // TAB SWITCHING
  calendarTabBtn.addEventListener("click",()=>{
    calendarCard.style.display="block";
    formCard.style.display="block";
    leaderboardSection.style.display="none";
    calendarTabBtn.className="primaryBtn";
    leaderboardTabBtn.className="secondary";
  });

  leaderboardTabBtn.addEventListener("click",async ()=>{
    calendarCard.style.display="none";
    formCard.style.display="none";
    leaderboardSection.style.display="block";
    calendarTabBtn.className="secondary";
    leaderboardTabBtn.className="primaryBtn";
    await renderLeaderboard();
  });

  async function renderLeaderboard(){
    const usersCol = collection(db,"users");
    const snapshot = await getDocs(usersCol);
    const users = snapshot.docs.map(d=>d.data());
    users.sort((a,b)=>b.wins - a.wins || b.pointsFor - a.pointsFor);
    const tbody = document.querySelector("#leaderboardTable tbody");
    tbody.innerHTML="";
    users.forEach((u,idx)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td style="padding:6px;border-bottom:1px solid #eee">${idx+1}</td>
        <td style="padding:6px;border-bottom:1px solid #eee">${u.name||u.email}</td>
        <td style="padding:6px;border-bottom:1px solid #eee">${u.wins||0}</td>
        <td style="padding:6px;border-bottom:1px solid #eee">${u.losses||0}</td>
        <td style="padding:6px;border-bottom:1px solid #eee">${u.pointsFor||0}</td>
        <td style="padding:6px;border-bottom:1px solid #eee">${u.pointsAgainst||0}</td>
      `;
      tbody.appendChild(tr);
    });
  }
</script>
</body>
</html>
