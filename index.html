<!DOCTYPE html>
<html>
<head>
  <title>Lekre≈°imir Wardell Hoops - Rezervacije</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background:#f5f5f5; margin:0; padding:0; }
    #loginForm, #calendarContainer { max-width: 500px; margin:auto; }
    input, textarea { display:block; margin:10px auto; width:80%; padding:8px; }
    button { padding:8px 16px; margin:5px; cursor:pointer; }
    #calendar { display:flex; flex-wrap:wrap; max-width:420px; margin:20px auto; }
    .day { border:1px solid #ccc; width:60px; height:60px; line-height:60px; cursor:pointer; margin:2px; font-weight:bold; position:relative; }
    .day:hover::after { content: attr(data-info); position:absolute; bottom:65px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:5px; font-size:12px; border-radius:4px; white-space:nowrap; }
    .available { background:#1D428A; color:#FFC72C; }
    .mine { background:#6BCBFF; color:#1D428A; }
    .reserved-other { background:orange; color:#fff; }
    .pending { background:yellow; color:#000; }
    .rejected, .past { background:red; color:#fff; cursor:not-allowed; }
    #reservationForm { display:none; margin-top:20px; }
    .legend { margin-top:20px; font-weight:bold; }
    .legend span { display:inline-block; width:20px; height:20px; margin-right:5px; vertical-align:middle; }
  </style>
</head>
<body>
  <div id="loginForm">
    <h1>Prijava</h1>
    <input type="email" id="email" placeholder="Email" required>
    <input type="password" id="password" placeholder="Lozinka" required>
    <button id="loginBtn">Prijavi se</button>
    <button id="registerBtn">Registriraj se</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <div id="calendarContainer" style="display:none;">
    <h1>Rezerviraj Hoop Sesh</h1>
    <button id="logoutBtn">Odjava</button>

    <div>
      <button id="prevMonth">‚Üê</button>
      <span id="monthYear"></span>
      <button id="nextMonth">‚Üí</button>
    </div>
    <div id="calendar"></div>

    <form id="reservationForm">
      <h2>Rezervacija za <span id="selectedDate"></span></h2>
      <label>Vrijeme: <input type="text" name="time" placeholder="npr. 18:00" required></label><br>
      <label>Teren: <input type="text" name="court" placeholder="npr. Teren 1" required></label><br>
      <label>Imena i prezimena (odvojena zarezom):</label><br>
      <textarea name="names" placeholder="Ime1 Prezime1, Ime2 Prezime2" required></textarea><br>
      <button type="submit">Rezerviraj</button>
      <button type="button" id="cancelBtn">Odustani</button>
    </form>

    <div class="legend">
      <div><span class="available"></span> Slobodno</div>
      <div><span class="pending"></span> ƒåeka odobrenje</div>
      <div><span class="mine"></span> Moj termin (odobreno)</div>
      <div><span class="reserved-other"></span> Tuƒëi termin (odobreno)</div>
      <div><span class="rejected"></span> Odbijeno / pro≈°lo</div>
    </div>
  </div>

  <script>
    // üîë Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAnFYrebR69a2rmYeT-TWrX1RB_Tzsh3Tk",
      authDomain: "hoops-165ec.firebaseapp.com",
      projectId: "hoops-165ec",
      storageBucket: "hoops-165ec.firebasestorage.app",
      messagingSenderId: "563400604791",
      appId: "1:563400604791:web:50183bcf65de09bd019a72",
      measurementId: "G-C3YPHXZCXN"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // üîë EmailJS init
    emailjs.init("rHykzq_BAVO2vvGfE"); // public key

    const loginForm = document.getElementById("loginForm");
    const calendarContainer = document.getElementById("calendarContainer");
    const loginError = document.getElementById("loginError");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const calendarEl = document.getElementById("calendar");
    const monthYearEl = document.getElementById("monthYear");
    const form = document.getElementById("reservationForm");
    const selectedDateEl = document.getElementById("selectedDate");
    const cancelBtn = document.getElementById("cancelBtn");

    let selectedDate = null;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let userEmail = null;

    // LOGIN
    document.getElementById("loginBtn").addEventListener("click", () => {
      auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value)
        .catch(err => loginError.textContent = err.message);
    });
    document.getElementById("registerBtn").addEventListener("click", () => {
      auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value)
        .catch(err => loginError.textContent = err.message);
    });
    document.getElementById("logoutBtn").addEventListener("click", () => { auth.signOut(); });
    auth.onAuthStateChanged(user => {
      if(user){
        userEmail = user.email;
        loginForm.style.display = "none";
        calendarContainer.style.display = "block";
        renderCalendar(currentMonth, currentYear);
      } else {
        loginForm.style.display = "block";
        calendarContainer.style.display = "none";
      }
    });

    // CALENDAR
    async function renderCalendar(month, year){
      calendarEl.innerHTML = "";
      const daysInMonth = new Date(year, month+1, 0).getDate();
      monthYearEl.textContent = `${year}-${month+1}`;

      const snapshot = await db.collection("reservations").get();
      const reservations = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

      for(let d=1; d<=daysInMonth; d++){
        const dateStr = `${year}-${month+1}-${d}`;
        const dayEl = document.createElement("div");
        dayEl.className = "day";
        dayEl.dataset.date = dateStr;
        dayEl.textContent = d;

        const today = new Date();
        const isPast = new Date(year, month, d) < new Date(today.getFullYear(), today.getMonth(), today.getDate());

        const res = reservations.find(r => r.date === dateStr);

        if(isPast){
          dayEl.classList.add("past");
        } else if(res){
          if(res.status === "pending"){
            dayEl.classList.add("pending");
          } else if(res.status === "approved"){
            if(res.userEmail === userEmail){
              dayEl.classList.add("mine");
            } else {
              dayEl.classList.add("reserved-other");
            }
          } else if(res.status === "rejected"){
            dayEl.classList.add("rejected");
          }
          dayEl.setAttribute("data-info", `${res.names} - ${res.time} - ${res.court}`);
        } else {
          dayEl.classList.add("available");
          dayEl.addEventListener("click",()=>selectDate(dateStr));
        }
        calendarEl.appendChild(dayEl);
      }
    }

    function selectDate(date){
      selectedDate = date;
      selectedDateEl.textContent = date;
      form.style.display = "block";
    }

    cancelBtn.addEventListener("click", ()=>{ form.reset(); form.style.display = "none"; });

    document.getElementById("prevMonth").addEventListener("click", ()=>{ currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} renderCalendar(currentMonth,currentYear); });
    document.getElementById("nextMonth").addEventListener("click", ()=>{ currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} renderCalendar(currentMonth,currentYear); });

    form.addEventListener("submit", async e=>{
      e.preventDefault();
      const time = form.time.value;
      const names = form.names.value;
      const court = form.court.value;

      const exists = await db.collection("reservations").where("date","==",selectedDate).where("time","==",time).get();
      if(!exists.empty){ alert("Termin veƒá rezerviran!"); return; }

      await db.collection("reservations").add({
        date: selectedDate,
        time,
        names,
        court,
        status: "pending",
        userEmail,
        joinRequests: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // EmailJS obavijest
      emailjs.send("service_cs8e9oq","template_phcx5cs",{
        date: selectedDate,
        time,
        names,
        court,
        user_email: userEmail
      });

      alert("Termin rezerviran! ƒåeka odobrenje.");
      form.reset();
      form.style.display = "none";
      renderCalendar(currentMonth,currentYear);
    });
  </script>
</body>
</html>
