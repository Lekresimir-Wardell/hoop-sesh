<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Rezervacije</title>
 
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0; }

    #loginWrapper {
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }
    #loginBox {
      background:white;
      padding:40px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.2);
      text-align:center;
      max-width:400px;
      width:100%;
    }
    #googleLoginBtn {
      padding:12px 24px;
      background:#1D428A;
      color:#FFC72C;
      font-size:16px;
      font-weight:bold;
      border:none;
      border-radius:8px;
      cursor:pointer;
    }

    #adminWrapper { display:none; padding:20px; }

    .tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap; }
    .tabBtn {
      padding:10px 20px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
      background:#ddd;
    }
    .tabBtn.active { background:#1D428A; color:#fff; }

    .list { display:none; }
    .list.active { display:block; }

    .reservation, .request, .game {
      background:white;
      padding:15px;
      margin:10px 0;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    button {
      padding:6px 12px;
      margin:4px;
      cursor:pointer;
    }
    .accept { background:green; color:white; border:none; border-radius:6px; }
    .reject { background:red; color:white; border:none; border-radius:6px; }

    /* NEW: Log Game form */
    #logGameForm { display:flex; flex-direction: column; gap:10px; max-width:400px; }
    #logGameForm select { padding:8px; border-radius:6px; border:1px solid #ccc; }
    #logGameForm button { background:#1D428A; color:#FFC72C; font-weight:bold; border:none; border-radius:6px; }

    /* NEW: Leaderboard table */
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { padding:8px; text-align:left; border-bottom:1px solid #ddd; }
    th { background:#1D428A; color:#fff; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginWrapper">
  <div id="loginBox">
    <h2>Admin prijava</h2>
    <button id="googleLoginBtn">Prijavi se s Googleom</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminWrapper">
  <h2>Admin panel</h2>
  <div class="tabs">
    <button class="tabBtn active" data-tab="reservationsTab">Rezervacije</button>
    <button class="tabBtn" data-tab="joinRequestsTab">Zahtjevi za pridruživanje</button>
    <button class="tabBtn" data-tab="logGameTab">Log Game</button>
    <button class="tabBtn" data-tab="leaderboardTab">Leaderboard</button>
  </div>

  <!-- Reservations -->
  <div id="reservationsTab" class="list active">
    <h3>Rezervacije</h3>
    <div id="reservationsList"></div>
  </div>

  <!-- Join Requests -->
  <div id="joinRequestsTab" class="list">
    <h3>Zahtjevi za pridruživanje</h3>
    <div id="joinRequestsList"></div>
  </div>

  <!-- Log Game -->
  <div id="logGameTab" class="list">
    <h3>Log Game</h3>
    <form id="logGameForm">
      <select id="team1" required>
        <option value="">Odaberite Team 1</option>
      </select>
      <input type="number" id="score1" placeholder="Team 1 Score" required>
      <select id="team2" required>
        <option value="">Odaberite Team 2</option>
      </select>
      <input type="number" id="score2" placeholder="Team 2 Score" required>
      <button type="submit">Log Game</button>
    </form>
  </div>

  <div id="leaderboardTab" class="list">
    <h3>Leaderboard</h3>
    <table id="leaderboardTable" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr style="background:#1D428A; color:white;">
          <th style="padding:8px; text-align:left;">Name</th>
          <th style="padding:8px; text-align:center;">Wins</th>
          <th style="padding:8px; text-align:center;">Losses</th>
          <th style="padding:8px; text-align:center;">Point Diff</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { 
    getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut 
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import { 
    getFirestore, collection, getDocs, updateDoc, doc, addDoc, query, orderBy 
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAnFYrebR69a2rmYeT-TWrX1RB_Tzsh3Tk",
    authDomain: "hoops-165ec.firebaseapp.com",
    projectId: "hoops-165ec",
    storageBucket: "hoops-165ec.firebasestorage.app",
    messagingSenderId: "563400604791",
    appId: "1:563400604791:web:50183bcf65de09bd019a72",
    measurementId: "G-C3YPHXZCXN"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  (function(){ emailjs.init("bHkaG3QCQ98fZq5Mu"); })();

  const loginWrapper = document.getElementById("loginWrapper");
  const adminWrapper = document.getElementById("adminWrapper");
  const loginBtn = document.getElementById("googleLoginBtn");
  const reservationsList = document.getElementById("reservationsList");
  const joinRequestsList = document.getElementById("joinRequestsList");
  const logGameForm = document.getElementById("logGameForm");
  const team1Select = document.getElementById("team1");
  const team2Select = document.getElementById("team2");
  const leaderboardBody = document.getElementById("leaderboardBody");

  let currentUser = null;
  let allTeams = []; // store team names

  // Google login
  loginBtn.addEventListener("click", async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (error) {
      alert("Greška prilikom prijave: " + error.message);
    }
  });

  onAuthStateChanged(auth, async (user) => {
    if (user && user.email === "linovernik@gmail.com") {
      currentUser = user;
      loginWrapper.style.display = "none";
      adminWrapper.style.display = "block";
      await loadTeams();
      loadReservations();
      loadJoinRequests();
      loadLeaderboard();
    } else if (user) {
      alert("Nemate pristup admin stranici.");
      signOut(auth);
    } else {
      loginWrapper.style.display = "flex";
      adminWrapper.style.display = "none";
    }
  });

  document.querySelectorAll(".tabBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".list").forEach(tab => tab.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });

  async function loadTeams(){
    team1Select.innerHTML = '<option value="">Odaberite Team 1</option>';
    team2Select.innerHTML = '<option value="">Odaberite Team 2</option>';
    const snapshot = await getDocs(collection(db,"users"));
    allTeams = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      allTeams.push(data.name);
    });
    allTeams.forEach(name=>{
      const opt1 = document.createElement("option");
      opt1.value = name; opt1.textContent = name;
      const opt2 = opt1.cloneNode(true);
      team1Select.appendChild(opt1);
      team2Select.appendChild(opt2);
    });
  }

  logGameForm.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const team1 = team1Select.value;
    const score1 = parseInt(document.getElementById("score1").value);
    const team2 = team2Select.value;
    const score2 = parseInt(document.getElementById("score2").value);

    if(!team1 || !team2 || team1===team2){
      alert("Odaberite dvije različite ekipe!");
      return;
    }

    const winner = score1 > score2 ? team1 : team2;

    // Update games collection
    await addDoc(collection(db,"games"), { team1, score1, team2, score2, winner });

    // Update leaderboard stats
    await updateLeaderboardStats(team1, score1, team2, score2);

    alert("Game logged!");
    logGameForm.reset();
    loadLeaderboard();
  });

  async function updateLeaderboardStats(t1,s1,t2,s2){
    const teamsRef = collection(db,"leaderboard");
    const snapshot = await getDocs(teamsRef);
    const leaderboard = {};
    snapshot.forEach(docSnap=>{
      leaderboard[docSnap.id] = docSnap.data();
    });

    [ [t1,s1,t2,s2], [t2,s2,t1,s1] ].forEach(([team,score,opp,oppScore])=>{
      const key = team;
      if(!leaderboard[key]){
        leaderboard[key] = { wins:0, losses:0, pointDiff:0 };
      }
      if(score>oppScore){
        leaderboard[key].wins +=1;
      } else {
        leaderboard[key].losses +=1;
      }
      leaderboard[key].pointDiff += (score-oppScore);
    });

    // write back
    for(const key in leaderboard){
      const docRef = doc(db,"leaderboard",key);
      await updateDoc(docRef, leaderboard[key]).catch(async ()=>{
        await setDoc(doc(db,"leaderboard",key), leaderboard[key]);
      });
    }
  }

  async function loadLeaderboard(){
    leaderboardBody.innerHTML = "";
    const snapshot = await getDocs(collection(db,"leaderboard"));
    const rows = [];
    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      rows.push({ name:docSnap.id, ...data });
    });
    // sort by wins desc
    rows.sort((a,b)=>b.wins-a.wins || b.pointDiff-a.pointDiff);
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r.name}</td><td style="text-align:center">${r.wins||0}</td><td style="text-align:center">${r.losses||0}</td><td style="text-align:center">${r.pointDiff||0}</td>`;
      leaderboardBody.appendChild(tr);
    });
  }

  async function loadReservations(){
    reservationsList.innerHTML="";
    const snapshot = await getDocs(collection(db,"reservations"));
    snapshot.forEach(docSnap=>{
      const r = docSnap.data();
      const div = document.createElement("div");
      div.className="reservation";
      div.textContent = `${r.name} — ${r.teren} — ${r.timestamp?.toDate().toLocaleString()||''}`;
      reservationsList.appendChild(div);
    });
  }

  async function loadJoinRequests(){
    joinRequestsList.innerHTML="";
    const snapshot = await getDocs(collection(db,"reservations"));
    snapshot.forEach(docSnap=>{
      const r = docSnap.data();
      if(r.joinRequests && r.joinRequests.length>0){
        r.joinRequests.forEach(j=>{
          const div = document.createElement("div");
          div.className="request";
          div.textContent = `${j.name} želi se pridružiti rezervaciji ${r.name}`;
          joinRequestsList.appendChild(div);
        });
      }
    });
  }

</script>
</body>
</html>
