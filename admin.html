<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Rezervacije</title>
 
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0; }

    #loginWrapper {
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }
    #loginBox {
      background:white;
      padding:40px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.2);
      text-align:center;
      max-width:400px;
      width:100%;
    }
    #googleLoginBtn {
      padding:12px 24px;
      background:#1D428A;
      color:#FFC72C;
      font-size:16px;
      font-weight:bold;
      border:none;
      border-radius:8px;
      cursor:pointer;
    }

    #adminWrapper { display:none; padding:20px; }

    .tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap; }
    .tabBtn {
      padding:10px 20px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
      background:#ddd;
    }
    .tabBtn.active { background:#1D428A; color:#fff; }

    .list { display:none; }
    .list.active { display:block; }

    .reservation, .request, .game {
      background:white;
      padding:15px;
      margin:10px 0;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    button {
      padding:6px 12px;
      margin:4px;
      cursor:pointer;
    }
    .accept { background:green; color:white; border:none; border-radius:6px; }
    .reject { background:red; color:white; border:none; border-radius:6px; }

    /* NEW: Log Game form */
    #logGameForm { display:flex; flex-direction: column; gap:10px; max-width:400px; }
    #logGameForm input, #logGameForm select { padding:8px; border-radius:6px; border:1px solid #ccc; }
    #logGameForm button { background:#1D428A; color:#FFC72C; font-weight:bold; border:none; border-radius:6px; }

    /* NEW: Leaderboard table */
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { padding:8px; text-align:left; border-bottom:1px solid #ddd; }
    th { background:#1D428A; color:#fff; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginWrapper">
  <div id="loginBox">
    <h2>Admin prijava</h2>
    <button id="googleLoginBtn">Prijavi se s Googleom</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminWrapper">
  <h2>Admin panel</h2>
  <div class="tabs">
    <button class="tabBtn active" data-tab="reservationsTab">Rezervacije</button>
    <button class="tabBtn" data-tab="joinRequestsTab">Zahtjevi za pridruživanje</button>
    <button class="tabBtn" data-tab="logGameTab">Log Game</button>
   <button class="tabBtn" data-tab="leaderboardTab">Leaderboard</button>
  </div>

  <!-- Reservations -->
  <div id="reservationsTab" class="list active">
    <h3>Rezervacije</h3>
    <div id="reservationsList"></div>
  </div>

  <!-- Join Requests -->
  <div id="joinRequestsTab" class="list">
    <h3>Zahtjevi za pridruživanje</h3>
    <div id="joinRequestsList"></div>
  </div>

  <!-- Log Game -->
  <div id="logGameTab" class="list">
    <h3>Log Game</h3>
    <form id="logGameForm">
      <input type="text" id="team1" placeholder="Team 1 Name" required>
      <input type="number" id="score1" placeholder="Team 1 Score" required>
      <input type="text" id="team2" placeholder="Team 2 Name" required>
      <input type="number" id="score2" placeholder="Team 2 Score" required>
      <button type="submit">Log Game</button>
    </form>
  </div>

 <div id="leaderboardTab" class="list">
  <h3>Leaderboard</h3>
  <table id="leaderboardTable" style="width:100%; border-collapse: collapse;">
    <thead>
      <tr style="background:#1D428A; color:white;">
        <th style="padding:8px; text-align:left;">Name</th>
        <th style="padding:8px; text-align:center;">Wins</th>
        <th style="padding:8px; text-align:center;">Losses</th>
        <th style="padding:8px; text-align:center;">Point Diff</th>
      </tr>
    </thead>
    <tbody id="leaderboardBody"></tbody>
  </table>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { 
    getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut 
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import { 
    getFirestore, collection, getDocs, updateDoc, doc, deleteDoc, addDoc, query, orderBy 
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAnFYrebR69a2rmYeT-TWrX1RB_Tzsh3Tk",
    authDomain: "hoops-165ec.firebaseapp.com",
    projectId: "hoops-165ec",
    storageBucket: "hoops-165ec.firebasestorage.app",
    messagingSenderId: "563400604791",
    appId: "1:563400604791:web:50183bcf65de09bd019a72",
    measurementId: "G-C3YPHXZCXN"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  (function(){ emailjs.init("bHkaG3QCQ98fZq5Mu"); })();

  const loginWrapper = document.getElementById("loginWrapper");
  const adminWrapper = document.getElementById("adminWrapper");
  const loginBtn = document.getElementById("googleLoginBtn");
  const reservationsList = document.getElementById("reservationsList");
  const joinRequestsList = document.getElementById("joinRequestsList");
  const leaderboardList = document.getElementById("leaderboardList");
  const logGameForm = document.getElementById("logGameForm");

  let currentUser = null;

  // Google login
  loginBtn.addEventListener("click", async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (error) {
      alert("Greška prilikom prijave: " + error.message);
    }
  });

  // Auth state
  onAuthStateChanged(auth, (user) => {
    if (user && user.email === "linovernik@gmail.com") {
      currentUser = user;
      loginWrapper.style.display = "none";
      adminWrapper.style.display = "block";
      loadReservations();
      loadJoinRequests();
      loadLeaderboard();
    } else if (user) {
      alert("Nemate pristup admin stranici.");
      signOut(auth);
    } else {
      loginWrapper.style.display = "flex";
      adminWrapper.style.display = "none";
    }
  });

  // Tabs
  document.querySelectorAll(".tabBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".list").forEach(tab => tab.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });

  // --------- Reservations and Join Requests (UNCHANGED) ---------
  async function loadReservations() {
    reservationsList.innerHTML = "";
    const snapshot = await getDocs(collection(db, "reservations"));
    const allReservations = [];
    snapshot.forEach(docSnap => {
      const r = docSnap.data();
      const email = r.user;
      allReservations.push({
        ...r,
        id: docSnap.id,
        email,
        createdAt: r.createdAt ? new Date(r.createdAt) : new Date(0)
      });
    });
    allReservations.sort((a, b) => b.createdAt - a.createdAt);
    allReservations.forEach(r => {
      if (r.status === "pending" || r.status === "accepted" || !r.status) {
        const div = document.createElement("div");
        div.classList.add("reservation");
        div.innerHTML = `
          <p><b>${r.name}</b> (${r.email || "—"})<br>
          Datum: ${r.date || "—"}, Vrijeme: ${r.time || "—"}, Teren: ${r.teren}</p>
          <p>Status: ${r.status || "pending"}</p>
          <button class="accept">Prihvati</button>
          <button class="reject">Odbij</button>
        `;
        div.querySelector(".accept").addEventListener("click", () => updateReservation(r.id, r, "accepted"));
        div.querySelector(".reject").addEventListener("click", () => updateReservation(r.id, r, "rejected"));
        reservationsList.appendChild(div);
      }
    });
  }

  async function updateReservation(id, r, status) {
    const docRef = doc(db, "reservations", id);
    if (status === "rejected") await deleteDoc(docRef);
    else await updateDoc(docRef, { status });
    const email = r.user;
    if (email) {
      try {
        await emailjs.send("service_8fwmwyi", "template_p01lv7f", {
          to_email: email,
          user_name: r.name,
          date: r.date,
          time: r.time,
          teren: r.teren,
          decision: status
        });
      } catch (err) { console.error(err); }
    }
    loadReservations();
  }

  async function loadJoinRequests() {
    joinRequestsList.innerHTML = "";
    const snapshot = await getDocs(collection(db, "reservations"));
    const allJoinRequests = [];
    snapshot.forEach(docSnap => {
      const r = docSnap.data();
      if (r.joinRequests && r.joinRequests.length > 0) {
        r.joinRequests.forEach((j, index) => {
          allJoinRequests.push({ ...j, reservationId: docSnap.id, joinIndex: index, createdAt: j.createdAt ? new Date(j.createdAt) : new Date(0) });
        });
      }
    });
    allJoinRequests.sort((a, b) => b.createdAt - a.createdAt);
    allJoinRequests.forEach((j) => {
      if (j.status === "pending" || j.status === "accepted") {
        const div = document.createElement("div");
        div.classList.add("request");
        div.innerHTML = `
          <p><b>${j.name}</b> (${j.email})<br>
          Poruka: ${j.message || "-"}</p>
          <p>Status: ${j.status}</p>
          <button class="accept">Prihvati</button>
          <button class="reject">Odbij</button>
        `;
        div.querySelector(".accept").addEventListener("click", () => updateJoinRequest(j.reservationId, j.joinIndex, j, "accepted"));
        div.querySelector(".reject").addEventListener("click", () => updateJoinRequest(j.reservationId, j.joinIndex, j, "rejected"));
        joinRequestsList.appendChild(div);
      }
    });
  }

  async function updateJoinRequest(reservationId, joinIndex, j, status) {
    const docRef = doc(db, "reservations", reservationId);
    const docSnap = await getDocs(docRef);
    const reservationData = docSnap.data();
    let updatedJoinRequests = [...(reservationData.joinRequests || [])];
    if (status === "rejected") updatedJoinRequests.splice(joinIndex, 1);
    else updatedJoinRequests[joinIndex] = { ...updatedJoinRequests[joinIndex], status };
    await updateDoc(docRef, { joinRequests: updatedJoinRequests });
    if (j.email) {
      try { await emailjs.send("service_8fwmwyi", "template_etn1gtm", { to_email: j.email, user_name: j.name, decision: status }); } 
      catch(err){console.error(err);}
    }
    loadJoinRequests();
  }

  // --------- NEW: Log Game ---------
  logGameForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const team1 = document.getElementById("team1").value;
    const score1 = parseInt(document.getElementById("score1").value);
    const team2 = document.getElementById("team2").value;
    const score2 = parseInt(document.getElementById("score2").value);
    const winner = score1 > score2 ? team1 : (score2 > score1 ? team2 : "Draw");

    await addDoc(collection(db, "games"), { team1, score1, team2, score2, winner, createdAt: new Date() });

    alert("Game logged!");
    logGameForm.reset();
    loadLeaderboard();
  });

  // --------- NEW: Leaderboard ---------
 const leaderboardBody = document.getElementById("leaderboardBody");

async function loadLeaderboard() {
  leaderboardBody.innerHTML = "";
  const snapshot = await getDocs(collection(db, "users"));
  const allUsers = [];

  snapshot.forEach(docSnap => {
    const u = docSnap.data();
    allUsers.push({
      name: u.name || "Unnamed",
      wins: u.wins || 0,
      losses: u.losses || 0,
      pointDiff: (u.pointsFor || 0) - (u.pointsAgainst || 0)
    });
  });

  // Sort: wins descending, then point differential descending
  allUsers.sort((a, b) => {
    if (b.wins !== a.wins) return b.wins - a.wins;
    return b.pointDiff - a.pointDiff;
  });

  allUsers.forEach(u => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding:6px;">${u.name}</td>
      <td style="padding:6px; text-align:center;">${u.wins}</td>
      <td style="padding:6px; text-align:center;">${u.losses}</td>
      <td style="padding:6px; text-align:center;">${u.pointDiff}</td>
    `;
    leaderboardBody.appendChild(tr);
  });
}

// Call this whenever admin logs in to refresh leaderboard
onAuthStateChanged(auth, (user) => {
  if (user && user.email === "linovernik@gmail.com") {
    loadLeaderboard();
  }
});


</script>
</body>
</html>
