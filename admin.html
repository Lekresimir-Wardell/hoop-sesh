<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - Rezervacije</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      color: #1D428A;
    }
    .reservation {
      background: white;
      padding: 15px;
      margin: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 400px;
    }
    button {
      margin: 5px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .accept { background: green; color: white; border: none; }
    .reject { background: red; color: white; border: none; }
  </style>
</head>
<body>
  <h1>Admin Panel - Rezervacije</h1>
  <div id="reservationsList"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
    import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // Firebase config (use same as index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyAnFYrebR69a2rmYeT-TWrX1RB_Tzsh3Tk",
      authDomain: "hoops-165ec.firebaseapp.com",
      projectId: "hoops-165ec",
      storageBucket: "hoops-165ec.firebasestorage.app",
      messagingSenderId: "563400604791",
      appId: "1:563400604791:web:50183bcf65de09bd019a72",
      measurementId: "G-C3YPHXZCXN"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Init EmailJS
    (function() {
      emailjs.init("bHkaG3QCQ98fZq5Mu"); 
    })();

    const reservationsList = document.getElementById("reservationsList");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Niste prijavljeni!");
        window.location.href = "index.html";
        return;
      }

      // Restrict to your admin email
      if (user.email !== "linovernik@gmail.com") {
        alert("Nemate pristup ovoj stranici!");
        window.location.href = "index.html";
        return;
      }

      loadReservations();
    });

    async function loadReservations() {
      reservationsList.innerHTML = "";
      const snapshot = await getDocs(collection(db, "reservations"));
      snapshot.forEach(docSnap => {
        const r = { id: docSnap.id, ...docSnap.data() };

        const div = document.createElement("div");
        div.classList.add("reservation");
        div.innerHTML = `
          <p><b>Ime:</b> ${r.name}</p>
          <p><b>Datum:</b> ${r.date}</p>
          <p><b>Vrijeme:</b> ${r.time}</p>
          <p><b>Teren:</b> ${r.teren}</p>
          <p><b>Status:</b> ${r.status}</p>
          <button class="accept">Prihvati</button>
          <button class="reject">Odbij</button>
        `;

        // Accept button
        div.querySelector(".accept").addEventListener("click", async () => {
          await updateDoc(doc(db, "reservations", r.id), { status: "accepted" });
          sendEmailDecision(r, "accepted");
          alert("Rezervacija prihvaÄ‡ena!");
          loadReservations();
        });

        // Reject button
        div.querySelector(".reject").addEventListener("click", async () => {
          await updateDoc(doc(db, "reservations", r.id), { status: "rejected" });
          sendEmailDecision(r, "rejected");
          alert("Rezervacija odbijena!");
          loadReservations();
        });

        reservationsList.appendChild(div);
      });
    }

    // Send email via EmailJS
    function sendEmailDecision(reservation, decision) {
      emailjs.send("service_8fwmwyi","template_p01lv7f",{
        to_email: reservation.user,
        name: reservation.name,
        date: reservation.date,
        time: reservation.time,
        teren: reservation.teren,
        status: decision
      }).then(() => {
        console.log("Email sent to user!");
      }).catch(err => console.error("Email error:", err));
    }
  </script>
</body>
</html>
