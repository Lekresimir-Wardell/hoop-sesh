<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Rezervacije</title>
 
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0; }

    #loginWrapper {
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }
    #loginBox {
      background:white;
      padding:40px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.2);
      text-align:center;
      max-width:400px;
      width:100%;
    }
    #googleLoginBtn {
      padding:12px 24px;
      background:#1D428A;
      color:#FFC72C;
      font-size:16px;
      font-weight:bold;
      border:none;
      border-radius:8px;
      cursor:pointer;
    }

    #adminWrapper { display:none; padding:20px; }

    .tabs { display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap; }
    .tabBtn {
      padding:10px 20px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:bold;
      background:#ddd;
    }
    .tabBtn.active { background:#1D428A; color:#fff; }

    .list { display:none; }
    .list.active { display:block; }

    .reservation, .request, .game {
      background:white;
      padding:15px;
      margin:10px 0;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    button {
      padding:6px 12px;
      margin:4px;
      cursor:pointer;
    }
    .accept { background:green; color:white; border:none; border-radius:6px; }
    .reject { background:red; color:white; border:none; border-radius:6px; }

    /* NEW: Log Game form */
    #logGameForm { display:flex; flex-direction: column; gap:10px; max-width:400px; }
    #logGameForm input, #logGameForm select { padding:8px; border-radius:6px; border:1px solid #ccc; }
    #logGameForm button { background:#1D428A; color:#FFC72C; font-weight:bold; border:none; border-radius:6px; }

    /* NEW: Leaderboard table */
    table { width:100%; border-collapse: collapse; margin-top:10px; }
    th, td { padding:8px; text-align:left; border-bottom:1px solid #ddd; }
    th { background:#1D428A; color:#fff; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginWrapper">
  <div id="loginBox">
    <h2>Admin prijava</h2>
    <button id="googleLoginBtn">Prijavi se s Googleom</button>
  </div>
</div>

<!-- ADMIN PANEL -->
<div id="adminWrapper">
  <h2>Admin panel</h2>
  <div class="tabs">
    <button class="tabBtn active" data-tab="reservationsTab">Rezervacije</button>
    <button class="tabBtn" data-tab="joinRequestsTab">Zahtjevi za pridruživanje</button>
    <button class="tabBtn" data-tab="logGameTab">Log Game</button>
    <button class="tabBtn" data-tab="leaderboardTab">Leaderboard</button>
  </div>

  <!-- Reservations -->
  <div id="reservationsTab" class="list active">
    <h3>Rezervacije</h3>
    <div id="reservationsList"></div>
  </div>

  <!-- Join Requests -->
  <div id="joinRequestsTab" class="list">
    <h3>Zahtjevi za pridruživanje</h3>
    <div id="joinRequestsList"></div>
  </div>

  <!-- Log Game -->
  <div id="logGameTab" class="list">
    <h3>Log Game</h3>
    <form id="logGameForm">
      <input type="text" id="team1" placeholder="Team 1 Name" required>
      <input type="number" id="score1" placeholder="Team 1 Score" required>
      <input type="text" id="team2" placeholder="Team 2 Name" required>
      <input type="number" id="score2" placeholder="Team 2 Score" required>
      <button type="submit">Log Game</button>
    </form>
  </div>

  <!-- Leaderboard -->
  <div id="leaderboardTab" class="list">
    <h3>Leaderboard</h3>
    <table id="leaderboardTable">
      <thead>
        <tr>
          <th>Name</th>
          <th style="text-align:center;">Wins</th>
          <th style="text-align:center;">Losses</th>
          <th style="text-align:center;">Point Diff</th>
        </tr>
      </thead>
      <tbody id="leaderboardBody"></tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { 
    getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut 
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import { 
    getFirestore, collection, getDocs, updateDoc, doc, deleteDoc, addDoc 
  } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAnFYrebR69a2rmYeT-TWrX1RB_Tzsh3Tk",
    authDomain: "hoops-165ec.firebaseapp.com",
    projectId: "hoops-165ec",
    storageBucket: "hoops-165ec.firebasestorage.app",
    messagingSenderId: "563400604791",
    appId: "1:563400604791:web:50183bcf65de09bd019a72",
    measurementId: "G-C3YPHXZCXN"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  (function(){ emailjs.init("bHkaG3QCQ98fZq5Mu"); })();

  const loginWrapper = document.getElementById("loginWrapper");
  const adminWrapper = document.getElementById("adminWrapper");
  const loginBtn = document.getElementById("googleLoginBtn");
  const reservationsList = document.getElementById("reservationsList");
  const joinRequestsList = document.getElementById("joinRequestsList");
  const logGameForm = document.getElementById("logGameForm");
  const leaderboardBody = document.getElementById("leaderboardBody");

  let currentUser = null;

  // Google login
  loginBtn.addEventListener("click", async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (error) {
      alert("Greška prilikom prijave: " + error.message);
    }
  });

  // Tabs
  document.querySelectorAll(".tabBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tabBtn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".list").forEach(tab => tab.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });

  // --------- Reservations & Join Requests ---------
  async function loadReservations() {
    reservationsList.innerHTML = "";
    const snapshot = await getDocs(collection(db, "reservations"));
    const allReservations = [];
    snapshot.forEach(docSnap => {
      const r = docSnap.data();
      allReservations.push({ ...r, id: docSnap.id, email: r.user, createdAt: r.createdAt ? new Date(r.createdAt) : new Date(0) });
    });
    allReservations.sort((a,b)=>b.createdAt-a.createdAt);
    allReservations.forEach(r => {
      if (r.status === "pending" || r.status === "accepted" || !r.status) {
        const div = document.createElement("div");
        div.classList.add("reservation");
        div.innerHTML = `<p><b>${r.name}</b> (${r.email || "—"})<br>Datum: ${r.date || "—"}, Vrijeme: ${r.time || "—"}, Teren: ${r.teren}</p><p>Status: ${r.status || "pending"}</p><button class="accept">Prihvati</button><button class="reject">Odbij</button>`;
        div.querySelector(".accept").addEventListener("click", ()=>updateReservation(r.id,r,"accepted"));
        div.querySelector(".reject").addEventListener("click", ()=>updateReservation(r.id,r,"rejected"));
        reservationsList.appendChild(div);
      }
    });
  }

  async function updateReservation(id,r,status){
    const docRef=doc(db,"reservations",id);
    if(status==="rejected") await deleteDoc(docRef);
    else await updateDoc(docRef,{status});
    if(r.user){try{await emailjs.send("service_8fwmwyi","template_p01lv7f",{to_email:r.user,user_name:r.name,date:r.date,time:r.time,teren:r.teren,decision:status})}catch(e){console.error(e)}}
    loadReservations();
  }

  async function loadJoinRequests(){
    joinRequestsList.innerHTML="";
    const snapshot=await getDocs(collection(db,"reservations"));
    const allJoinRequests=[];
    snapshot.forEach(docSnap=>{
      const r=docSnap.data();
      if(r.joinRequests&&r.joinRequests.length>0){
        r.joinRequests.forEach((j,index)=>{
          allJoinRequests.push({...j,reservationId:docSnap.id,joinIndex:index,createdAt:j.createdAt?new Date(j.createdAt):new Date(0)});
        });
      }
    });
    allJoinRequests.sort((a,b)=>b.createdAt-a.createdAt);
    allJoinRequests.forEach(j=>{
      if(j.status==="pending"||j.status==="accepted"){
        const div=document.createElement("div");
        div.classList.add("request");
        div.innerHTML=`<p><b>${j.name}</b> (${j.email})<br>Poruka: ${j.message||"-"}</p><p>Status: ${j.status}</p><button class="accept">Prihvati</button><button class="reject">Odbij</button>`;
        div.querySelector(".accept").addEventListener("click",()=>updateJoinRequest(j.reservationId,j.joinIndex,j,"accepted"));
        div.querySelector(".reject").addEventListener("click",()=>updateJoinRequest(j.reservationId,j.joinIndex,j,"rejected"));
        joinRequestsList.appendChild(div);
      }
    });
  }

  async function updateJoinRequest(reservationId,joinIndex,j,status){
    const docRef=doc(db,"reservations",reservationId);
    const docSnap=await getDocs(docRef);
    const reservationData=docSnap.data();
    let updatedJoinRequests=[...(reservationData.joinRequests||[])];
    if(status==="rejected") updatedJoinRequests.splice(joinIndex,1);
    else updatedJoinRequests[joinIndex]={...updatedJoinRequests[joinIndex],status};
    await updateDoc(docRef,{joinRequests:updatedJoinRequests});
    if(j.email){try{await emailjs.send("service_8fwmwyi","template_etn1gtm",{to_email:j.email,user_name:j.name,decision:status})}catch(e){console.error(e)}}
    loadJoinRequests();
  }

  // --------- Log Game & Update Users ---------
  logGameForm.addEventListener("submit",async(e)=>{
    e.preventDefault();
    const team1=document.getElementById("team1").value.trim();
    const score1=parseInt(document.getElementById("score1").value);
    const team2=document.getElementById("team2").value.trim();
    const score2=parseInt(document.getElementById("score2").value);
    const winner=score1>score2?team1:team2;

    await addDoc(collection(db,"games"),{team1,score1,team2,score2,winner,createdAt:new Date()});
    await updateUsersAfterGame(team1,score1,team2,score2);

    alert("Game logged!");
    logGameForm.reset();
    loadLeaderboard();
  });

  async function updateUsersAfterGame(team1,score1,team2,score2){
    const usersCol=collection(db,"users");
    const snapshot=await getDocs(usersCol);
    const users={};
    snapshot.forEach(docSnap=>{
      const data=docSnap.data();
      users[data.name]={id:docSnap.id,...data};
    });

    // create teams if not exist
    if(!users[team1]){const docRef=await addDoc(usersCol,{name:team1,wins:0,losses:0,pointsFor:0,pointsAgainst:0}); users[team1]={id:docRef.id,name:team1,wins:0,losses:0,pointsFor:0,pointsAgainst:0};}
    if(!users[team2]){const docRef=await addDoc(usersCol,{name:team2,wins:0,losses:0,pointsFor:0,pointsAgainst:0}); users[team2]={id:docRef.id,name:team2,wins:0,losses:0,pointsFor:0,pointsAgainst:0};}

    const updates=[
      {user:users[team1],wins:score1>score2?1:0,losses:score1<score2?1:0,pointsFor:score1,pointsAgainst:score2},
      {user:users[team2],wins:score2>score1?1:0,losses:score2<score1?1:0,pointsFor:score2,pointsAgainst:score1}
    ];

    for(const u of updates){
      const docRef=doc(db,"users",u.user.id);
      await updateDoc(docRef,{
        wins:(u.user.wins||0)+u.wins,
        losses:(u.user.losses||0)+u.losses,
        pointsFor:(u.user.pointsFor||0)+u.pointsFor,
        pointsAgainst:(u.user.pointsAgainst||0)+u.pointsAgainst
      });
    }
  }

  async function loadLeaderboard() {
  leaderboardBody.innerHTML = "";

  // 1. Fetch all users
  const usersSnap = await getDocs(collection(db, "users"));
  const usersMap = {};
  usersSnap.forEach(docSnap => {
    const u = docSnap.data();
    usersMap[u.uid] = {
      name: u.name || "Unnamed",
      wins: 0,
      losses: 0,
      pointsFor: 0,
      pointsAgainst: 0,
      uid: u.uid
    };
  });

  // 2. Fetch all games
  const gamesSnap = await getDocs(collection(db, "games"));
  gamesSnap.forEach(docSnap => {
    const g = docSnap.data();

    // identify team1 and team2 by name
    const t1 = Object.values(usersMap).find(u => u.name === g.team1);
    const t2 = Object.values(usersMap).find(u => u.name === g.team2);

    if (!t1 || !t2) return; // skip if a user doesn't exist yet

    t1.pointsFor += g.score1;
    t1.pointsAgainst += g.score2;
    t2.pointsFor += g.score2;
    t2.pointsAgainst += g.score1;

    if (g.score1 > g.score2) {
      t1.wins += 1;
      t2.losses += 1;
    } else if (g.score2 > g.score1) {
      t2.wins += 1;
      t1.losses += 1;
    }
    // draw → no wins/losses
  });

  // 3. Convert to array and sort
  const leaderboardArray = Object.values(usersMap);
  leaderboardArray.sort((a,b)=>{
    if (b.wins !== a.wins) return b.wins - a.wins;
    return (b.pointsFor - b.pointsAgainst) - (a.pointsFor - a.pointsAgainst);
  });

  // 4. Render table
  leaderboardArray.forEach(u=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="padding:6px;">${u.name}</td>
      <td style="padding:6px; text-align:center;">${u.wins}</td>
      <td style="padding:6px; text-align:center;">${u.losses}</td>
      <td style="padding:6px; text-align:center;">${u.pointsFor - u.pointsAgainst}</td>
    `;
    leaderboardBody.appendChild(tr);
  });
}

  // --------- Auth State ---------
  onAuthStateChanged(auth,(user)=>{
    if(user && user.email==="linovernik@gmail.com"){
      currentUser=user;
      loginWrapper.style.display="none";
      adminWrapper.style.display="block";
      loadReservations();
      loadJoinRequests();
      loadLeaderboard();
    } else if(user){ alert("Nemate pristup admin stranici."); signOut(auth);}
    else{loginWrapper.style.display="flex"; adminWrapper.style.display="none";}
  });

</script>
</body>
</html>
